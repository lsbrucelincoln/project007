<div class="addAssessment admin_content_innerBox dataManagement" id="analysisBody">
    <div class="minibar"><i class="flaticon-arrows-4"></i><span>当前位置：首页 > 评估标准管理 > <span class="nowPlace">评估场景预设</span></span>
    </div>
    <div class="admin_scrollBox">
        <div class="contentBody">
            <div class="dataPage">
                <div class="inputShort assessType" style="width:250px"><span style="width:80px">选择企业类型:</span>
                    <div class="admin_ui_select" style="width: 140px;">
                        <select>
                            <option value="">危险品类</option>
                        </select>
                    </div>
                </div>
                <div class="inputShort assessType" style="width:620px"><span style="width:80px">选择任务类型:</span>
                    <div class="admin_ui_select" style="width:120px">
                        <select name="" id="" v-model="mode">
                            <option value="日常评估">日常评估检查</option>
                            <option value="专项评估">专项评估检查</option>
                            <option value="综合评估">综合评估检查</option>
                        </select>
                    </div> <span v-if="mode=='专项评估'" style="width:5px">—</span>
                    <div class="admin_ui_select" v-if="mode=='专项评估'" style="width:100px">
                        <select name="" id="" v-model="special">
                            <option v-for="check in specialCheck" value="{{check}}">{{check}}</option>
                            <option value="add">新增专项</option>
                        </select>
                    </div>
                    <input type="text" v-model="addSpecial" v-if="mode=='专项评估'&special=='add'" style="width:100px">
                    <div class="addBtn normalBtn" v-if="mode=='专项评估'&special=='add'" @click="addSpecialEvent">确认添加</div>
                    <input type="checkBox" id="canUse">
                    <label for="canUse">只看有效</label>
                </div>
                <div class="dataOutBtn normalBtn" style="float:right">导出数据</div>
                <div class="assess2Body">
                    <div class="ztrbox">
                        <div class="ztreeBox ztree">
                            <a class="category1" v-for="(index,item) in category" @click="state[$index]==1?state.$set($index,0):state.$set($index,1)"><i class="flaticon-add-1" v-if="!state[$index]==1"></i><i class="flaticon-square" v-if="state[$index]==1"></i>{{index}}
                            <ul class="line" v-if="state[$index]==1"><li class="category2" v-for="(index2,item2) in item"  @click.stop="showData(item2,$event)"><i class="flaticon-interface"></i>{{index2}}</li></ul>
                            </a>
                        </div>
                        <!--                         <i class="treeAdd">+</i>
                        <i class="treeRemove">-</i> -->
                    </div>
                    <div class="tableBox">
                        <table>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkBox" id="person1" class="checkBox">
                                </th>
                                <th width="240px">内容</th>
                                <th style="width: 40px;">等级</th>
                                <th style="width: 60px;">强制执行</th>
                                <th style="width: 100px;">更新时间</th>
                                <th style="width: 100px;">当前状态</th>
                                <th style="width: 80px;">操作</th>
                            </tr>
                            <tr v-for="rule in rules |limitBy recordLimit startPoint">
                                <td>
                                    <input type="checkBox" id="person1" class="checkBox">
                                </td>
                                <td style="text-align:left">{{rule.text}}</td>
                                <td>{{rule.safetyLevel}}</td>
                                <td>{{rule.must?"是":""}}</td>
                                <td>06/01 20:00</td>
                                <td></td>
                                <td><a href="#/ruleDetail.html" @click="saveDetail(rule)">查看</a> </td>
                            </tr>
                        </table>
                        <div class="bottom-search">
                            <div class="allSelectBtn normalBtn" style="margin-top:15px">全选</div>
                            <div class="addBtn normalBtn" style="margin-top:15px">添加</div>
                            <div class="urgeBtn normalBtn" style="margin-top:15px">禁用</div>
                            <div class="page"><a href="javascript:void(0)" @click="prevPage"><span id="Prev">« 上一页</span></a>
                                <a href="javascript:void(0)" v-for="n in pageNum" v-show="showPageTag(n)">
                                    <span @click="turnPage(n)" class="{{(n+1==pageIndex?'click_page':'normalPage')}}"> {{n+1}} </span>
                                </a>
                                <a href="javascript:void(0)" @click="nextPage">
                                    <span id="Next">下一页 »</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
$(document).ready(function() {
    // TablePage("table", 10);
    $("th .checkBox").on('click', function(event) {
        if ($(this).prop('checked')) {
            $("td .checkBox").prop("checked", true);
        } else {
            $("td .checkBox").prop("checked", false);
        }
    });
    $(".admin_content_table").on('click', ".allSelectBtn", function(event) {
        $("td .checkBox").prop("checked", true);
    });
    $("#processingBtn").on('click', function(event) {
        event.preventDefault();
        $(".processingTable").show();
        $(".finishedTable").hide();
        $(this).addClass('chosen');
        $("#finishedBtn").removeClass('chosen');
    });
    $("#finishedBtn").on('click', function(event) {
        event.preventDefault();
        $(".processingTable").hide();
        $(".finishedTable").show();
        $(this).addClass('chosen');
        $("#processingBtn").removeClass('chosen');
    });
    $(".rightBox").on('click', "p", function(event) {
        $(".leftBox").append($(this));
    });
    $(".leftBox").on('click', "p", function(event) {
        $(".rightBox").append($(this));
    });
    var vm = new Vue({
        el: "#analysisBody",
        data: {
            state: [1],
            rules: [],
            companyList: [],
            companyName: "",
            createTimeList: [],
            createTime: "",
            risks: {},
            category: {},
            recordLimit: 7,
            pageIndex: 1,
            startAttr: "",
            startAttr2: "",
            rawData: [],
            mode: "日常评估",
            addSpecial: '',
            special: "",
            specialCheck: []
        },
        computed: {
            startPoint: function() {
                return (this.pageIndex - 1) * 5
            },
            pageNum: function() {
                return Math.ceil(this.rules.length / this.recordLimit)
            },
        },
        methods: {
            rulesDetail: function(data) {
                var category = {};
                var category2 = [];
                for (var i = 0; i < data.length; i++) {
                    if (i == 0) {
                        vm.startAttr = data[i].category1;
                        vm.startAttr2 = data[i].category2;
                    }
                    if (!category[data[i].category1]) {
                        category[data[i].category1] = {}
                        category[data[i].category1][data[i].category2] = [];
                        category[data[i].category1][data[i].category2].push(data[i]);
                    } else {
                        if (!category[data[i].category1][data[i].category2]) {
                            category[data[i].category1][data[i].category2] = [];
                            category[data[i].category1][data[i].category2].push(data[i]);
                        } else {
                            category[data[i].category1][data[i].category2].push(data[i]);
                        }
                    }
                }
                for (var i = 0; i < vm.category.length; i++) {
                    vm.state[i] = 1;
                    vm.state.$set(i, 1);
                }
                console.log(category);
                vm.rules = vm.rawData;
                this.category = category;
            },
            showData: function(data, event) {
                this.rules = data;
                this.pageIndex = 1;
                $(".category2").removeClass('chosenCategory');
                $(event.target).addClass('chosenCategory');
            },
            stateChange: function(index) {},
            stamp2time: function(stamp) {
                var time = new Date(stamp);
                var year = time.getFullYear();
                var month = time.getMonth() - 0 + 1;
                var hours = time.getHours();
                var minutes = time.getMinutes();
                month = month < 10 ? "0" + month : month;
                var day = time.getDate();
                day = day < 10 ? "0" + day : day;
                hours = hours < 10 ? "0" + hours : hours;
                minutes = minutes < 10 ? "0" + minutes : minutes;
                var timeString = '';
                return month + "/" + day + " " + hours + ":" + minutes;
            },
            dayPeriodCompute: function(startTime, endTime) {
                var nowTime = new Date(startTime);
                var theTime = new Date(endTime);
                return theTime.getDate() - nowTime.getDate();
            },
            unique: function(arr) {
                var result = [],
                    hash = {};
                for (var i = 0, elem;
                    (elem = arr[i]) != null; i++) {
                    if (!hash[elem]) {
                        result.push(elem);
                        hash[elem] = true;
                    }
                }
                return result.reverse();
            },
            prevPage: function() {
                if (this.pageIndex - 1 > 0) {
                    this.pageIndex = this.pageIndex - 1;
                }
            },
            nextPage: function() {
                if (this.pageIndex + 1 <= this.pageNum) {
                    this.pageIndex = this.pageIndex + 1;
                }
            },
            turnPage: function(data) {
                vm.pageIndex = data + 1;
            },
            clickPageFilter: function(data) {
                console.log(data);
                if (data + 1 == vm.pageIndex) {
                    return true;
                } else {
                    return false;
                }
            },
            showPageTag: function(data) {
                console.log(data - this.pageIndex);
                if (data == this.pageNum - 1 || data == 0 || ((data - this.pageIndex) < 1) && (data - this.pageIndex) >= -2) {
                    return true
                } else {
                    return false
                }
            },
            saveDetail: function(data) {
                localStorage.setItem("ruleDetail", JSON.stringify(data))
            },
            addSpecialEvent: function(data) {
                var self = this;
                if (self.addSpecial) {
                    if (confirm("确认增加一个专项")) {
                        var list = self.specialCheck.slice(0);
                        list.push(self.addSpecial);
                        console.log(self.addSpecial);
                        console.log(list);
                        $.ajax({
                                url: '/region/resetSpecial',
                                type: 'POST',
                                data: {
                                    special: list
                                },
                                traditional :true,
                            })
                            .done(function(data) {
                                if (data.state == 0) {
                                    self.specialCheck.push(self.addSpecial);
                                    alert("新增成功");
                                    self.special=self.addSpecial;
                                }
                            })
                    }
                } else {
                    alert("请输入新专项的名字")
                }
            }
        },
        created: function() {
            var self = this;
            var id = localStorage.getItem("id");
            $.post('/model', {
                name: "SafeRule",
                rows: 0
            }, function(data, textStatus, xhr) {
                console.log(data);
                if (data.state == 0) {
                    vm.rawData = data.data
                    vm.rulesDetail(data.data)
                }
            });
            $.post('/model', {
                name: "Region",
            }, function(data, textStatus, xhr) {
                if (data.state == 0) {
                    vm.specialCheck = data.data[0].special;
                }
            });
        },
        ready: function() {

        }
    })
});
</script>
